name: Viral_Video_v31_Strict_Luxury
on:
  repository_dispatch:
    types: [start_smart_render]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install_Tools
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg imagemagick
          sudo find /etc/ImageMagick* -name "policy.xml" -exec sed -i 's/policy domain="path" rights="none" pattern="@\*"/policy domain="path" rights="read|write" pattern="@\*"/g' {} +
          pip install "Pillow<10.0.0" moviepy==1.0.3 requests opencv-python-headless "imageio[pyav]" imageio-ffmpeg

      - name: Video_Rendering
        run: |
          python - <<EOF
          import os, requests, re, urllib.parse, sys
          from moviepy.editor import AudioFileClip, ColorClip, ImageClip, concatenate_videoclips, CompositeVideoClip

          # 1. AUDIO DOWNLOADER
          def get_audio(id, dest):
              try:
                  url = f"https://docs.google.com/uc?export=download&id={id}"
                  s = requests.Session()
                  r = s.get(url, stream=True)
                  t = next((v for k, v in r.cookies.items() if k.startswith('download_warning')), None)
                  if t: r = s.get(url, params={'id': id, 'confirm': t}, stream=True)
                  with open(dest, "wb") as f:
                      for c in r.iter_content(32768):
                          if c: f.write(c)
                  return os.path.exists(dest) and os.path.getsize(dest) > 1000
              except: return False

          # 2. STRICT DOWNLOADER (No Random Fallback)
          def download_file(url, filename):
              try:
                  headers = {
                      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      'Referer': 'https://pollinations.ai/'
                  }
                  # Increased timeout for high-quality AI generation
                  r = requests.get(url, headers=headers, timeout=45)
                  
                  # Verify it's a real image (usually > 5KB)
                  if r.status_code == 200 and len(r.content) > 5000:
                      with open(filename, "wb") as f: f.write(r.content)
                      return True
              except: pass
              return False

          def get_image_strict(prompt, idx):
              filename = f"img_{idx}.jpg"
              clean_p = re.sub(r'^\d+[\.\s\-]+', '', prompt.strip())
              
              # FIX: Subject FIRST, Style SECOND
              # This ensures the AI draws YOUR prompt, then adds the luxury style.
              final_prompt = f"{clean_p}, masterpiece, 8k, highly detailed, billionaire luxury lifestyle, cinematic lighting, photorealistic"
              
              encoded_prompt = urllib.parse.quote(final_prompt)
              
              # LAYER 1: Flux (High Quality)
              print(f"--- Scene {idx}: Trying Flux for '{clean_p}'... ---")
              url_flux = f"https://pollinations.ai/p/{encoded_prompt}?width=1080&height=1920&model=flux&seed={idx+300}"
              if download_file(url_flux, filename): return filename
              
              # LAYER 2: Turbo (Backup AI)
              print(f"--- Scene {idx}: Flux busy. Trying Turbo... ---")
              url_turbo = f"https://pollinations.ai/p/{encoded_prompt}?width=1080&height=1920&model=turbo"
              if download_file(url_turbo, filename): return filename

              # NO LAYER 3.
              # If we fail here, we prefer Black Screen over "Wrong Image".
              print(f"--- Scene {idx}: AI Generation Failed. Skipping... ---")
              return None

          try:
              raw_prompts = "${{ github.event.client_payload.visual_prompts }}"
              prompts = [p.strip() for p in raw_prompts.split('|') if len(p.strip()) > 5]
              audio_url = "${{ github.event.client_payload.audio_url }}"
              
              audio_id_match = re.search(r'id=([a-zA-Z0-9_-]+)', audio_url)
              if not audio_id_match: raise Exception("Audio ID missing")
              
              get_audio(audio_id_match.group(1), "audio.mp3")
              audio = AudioFileClip("audio.mp3")
              dur = audio.duration / len(prompts)
              
              clips = []
              for i, p in enumerate(prompts):
                  img_path = get_image_strict(p, i)
                  
                  if img_path:
                      bg = ImageClip(img_path).set_duration(dur).set_fps(24)
                  else:
                      # If you see BLACK screens now, it means Pollinations is 100% blocking us.
                      # This is better than seeing "Wrong Images".
                      bg = ColorClip(size=(1080, 1920), color=(0, 0, 0)).set_duration(dur)
                  
                  # Zoom Effect (No Text)
                  scene = bg.resize(lambda t: 1 + 0.06 * t) 
                  clips.append(scene)
              
              if clips:
                  final = concatenate_videoclips(clips, method="compose").set_audio(audio)
                  final.write_videofile("production_video.mp4", codec="libx264", audio_codec="aac", fps=24, threads=4, preset='ultrafast', ffmpeg_params=['-pix_fmt', 'yuv420p'])
                  print("RENDER_SUCCESS")
              else:
                  print("Error: No clips generated")
                  
          except Exception as e:
              print(f"Error: {e}")
              sys.exit(1)
          EOF

      - name: Save_Video_File
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: My_Final_Video
          path: production_video.mp4
          retention-days: 1

      - name: Agent_Callback
        if: always()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"finished\", \"info\": \"v31 Strict Mode\"}" || true
