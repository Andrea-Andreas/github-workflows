name: Viral_Video_v33_Stable_Base
on:
  repository_dispatch:
    types: [start_smart_render]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install_Tools
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg imagemagick
          sudo find /etc/ImageMagick* -name "policy.xml" -exec sed -i 's/policy domain="path" rights="none" pattern="@\*"/policy domain="path" rights="read|write" pattern="@\*"/g' {} +
          pip install "Pillow<10.0.0" moviepy==1.0.3 requests opencv-python-headless "imageio[pyav]" imageio-ffmpeg

      - name: Video_Rendering
        shell: python
        run: |
          import os, requests, re, sys, random, time
          from moviepy.editor import AudioFileClip, ImageClip, concatenate_videoclips, TextClip, CompositeVideoClip, vfx
          from moviepy.audio.AudioClip import CompositeAudioClip
          from moviepy.audio.fx.all import loop as audio_loop

          def get_audio(id, dest):
              try:
                  url = f"https://docs.google.com/uc?export=download&id={id}"
                  s = requests.Session()
                  r = s.get(url, stream=True)
                  t = next((v for k, v in r.cookies.items() if k.startswith('download_warning')), None)
                  if t: r = s.get(url, params={'id': id, 'confirm': t}, stream=True)
                  with open(dest, "wb") as f:
                      for c in r.iter_content(32768):
                          if c: f.write(c)
                  return os.path.exists(dest) and os.path.getsize(dest) > 1000
              except Exception as e:
                  print(f"Download Error: {e}")
                  return False

          def get_random_asset(folder, extensions):
              if os.path.exists(folder):
                  files = [os.path.join(folder, f) for f in os.listdir(folder) if f.lower().endswith(extensions) and 'keep' not in f]
                  if files: return random.choice(files)
              return None

          try:
              script_text = """${{ github.event.client_payload.script_text }}"""
              visual_prompts = "${{ github.event.client_payload.visual_prompts }}"
              audio_url = "${{ github.event.client_payload.audio_url }}"
              
              final_text = script_text if len(script_text) > 10 else visual_prompts.replace("|", " ")
              
              words = final_text.split()
              chunk_size = 4
              chunks = [" ".join(words[i:i + chunk_size]) for i in range(0, len(words), chunk_size)]

              audio_id_match = re.search(r'id=([a-zA-Z0-9_-]+)', audio_url)
              if not audio_id_match: sys.exit(1)
              
              if not get_audio(audio_id_match.group(1), "voice.mp3"): sys.exit(1)
              voice = AudioFileClip("voice.mp3")
              
              # Music Background Logic with Loop fix
              bg_music_path = get_random_asset("music", ".mp3")
              if bg_music_path:
                  bg_music = AudioFileClip(bg_music_path
