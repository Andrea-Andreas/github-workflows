name: Viral_Video_Engine_v10
on:
  repository_dispatch:
    types: [start_smart_render]

jobs:
  build_video:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          sudo sed -i 's/policy domain="path" rights="none" pattern="@\*"/policy domain="path" rights="read|write" pattern="@\*"/g' /etc/ImageMagick-6/policy.xml
      - name: Install Python Libraries
        run: |
          pip install moviepy==1.0.3 requests gdown
      - name: Production
        run: |
          python - <<EOF
          import os, requests, gdown
          from moviepy.editor import TextClip, AudioFileClip, concatenate_videoclips

          try:
              # 1. Data Extraction
              raw_prompts = "${{ github.event.client_payload.visual_prompts }}"
              visual_prompts = [p.strip() for p in raw_prompts.split('|') if len(p.strip()) > 5]
              audio_url = "${{ github.event.client_payload.audio_url }}"
              audio_id = audio_url.split('id=')[-1]
              callback = "${{ github.event.client_payload.callback_url }}"
              
              # 2. Advanced Download using gdown
              print(f"Targeting Audio ID: {audio_id}")
              download_url = f'https://drive.google.com/uc?id={audio_id}'
              gdown.download(download_url, 'audio.mp3', quiet=False)
              
              # Verify if it's a real file (not HTML)
              with open('audio.mp3', 'rb') as f:
                  header = f.read(100)
                  if b'<html' in header.lower() or b'<!doctype' in header.lower():
                      raise Exception("Downloaded file is HTML, not MP3. Check Drive permissions.")

              # 3. Processing
              audio = AudioFileClip("audio.mp3")
              dur = audio.duration / len(visual_prompts)
              print(f"Total duration: {audio.duration}s. Scenes: {len(visual_prompts)}")
              
              clips = [TextClip(p, fontsize=55, color='white', size=(1080,1920), method='caption', align='Center').set_duration(dur).set_fps(24).resize(lambda t: 1 + 0.04 * t) for p in prompts]
              
              # 4. Final Render
              final = concatenate_videoclips(clips, method="compose").set_audio(audio)
              final.write_videofile("final_video.mp4", codec="libx264", audio_codec="aac", fps=24, threads=4)
              
              # 5. Result Upload
              link = os.popen("curl --upload-file ./final_video.mp4 https://bashupload.com/viral_video_v10.mp4").read().strip()
              print(f"\n\nSUCCESS! DOWNLOAD LINK: {link}\n\n")
              
              requests.post(callback, json={"status": "success", "download_url": link})
          except Exception as e:
              print(f"Production Failed: {e}")
