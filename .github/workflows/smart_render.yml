name: Viral_Video_Engine_v14
on:
  repository_dispatch:
    types: [start_smart_render]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          sudo find /etc/ImageMagick* -name "policy.xml" -exec sed -i 's/policy domain="path" rights="none" pattern="@\*"/policy domain="path" rights="read|write" pattern="@\*"/g' {} +
          pip install "Pillow<10.0.0" moviepy==1.0.3 requests
      - name: Render
        run: |
          python - <<EOF
          import os, requests, re
          from moviepy.editor import TextClip, AudioFileClip, concatenate_videoclips

          def download_drive(id, dest):
              url = f"https://docs.google.com/uc?export=download&id={id}"
              s = requests.Session()
              s.headers.update({'User-Agent': 'Mozilla/5.0'})
              r = s.get(url, stream=True)
              t = next((v for k, v in r.cookies.items() if k.startswith('download_warning')), None)
              if t: r = s.get(url, params={'id': id, 'confirm': t}, stream=True)
              with open(dest, "wb") as f:
                  for c in r.iter_content(32768):
                      if c: f.write(c)

          try:
              raw_prompts = "${{ github.event.client_payload.visual_prompts }}"
              prompts = [p.strip() for p in raw_prompts.split('|') if len(p.strip()) > 5]
              audio_url = "${{ github.event.client_payload.audio_url }}"
              audio_id = re.search(r'id=([a-zA-Z0-9_-]+)', audio_url).group(1)
              callback = "${{ github.event.client_payload.callback_url }}"
              
              download_drive(audio_id, "audio.mp3")
              audio = AudioFileClip("audio.mp3")
              dur = audio.duration / len(prompts)
              
              clips = [TextClip(p, fontsize=50, color='white', font='Arial-Bold', size=(1080,1920), method='caption').set_duration(dur).set_fps(24).resize(lambda t: 1 + 0.04 * t) for p in prompts]
              
              final = concatenate_videoclips(clips, method="compose").set_audio(audio)
              final.write_videofile("final_video.mp4", codec="libx264", audio_codec="aac", fps=24, threads=4)
              
              # Using file.io for more stability
              res = os.popen("curl -F 'file=@final_video.mp4' https://file.io").read()
              link = re.search(r'"link":"(https://file.io/[a-zA-Z0-9]+)"', res).group(1)
              print(f"\n\nSUCCESS! DOWNLOAD LINK: {link}\n\n")
              
              requests.post(callback, json={"status": "success", "download_url": link})
          except Exception as e:
              print(f"Log: {e}")
