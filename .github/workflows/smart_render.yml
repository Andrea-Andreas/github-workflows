name: Smart_Video_Agent
on:
  repository_dispatch:
    types: [start_smart_render]

jobs:
  render_process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout_Repository
        uses: actions/checkout@v4

      - name: Setup_Tools
        run: sudo apt-get update && sudo apt-get install -y ffmpeg curl

      - name: Process_Video
        run: |
          mkdir -p workspace
          IMAGE_LIST="${{ github.event.client_payload.image_urls }}"
          AUDIO_URL="${{ github.event.client_payload.audio_url }}"
          
          # Download images and create a manifest for FFmpeg
          IFS=',' read -ra ADDR <<< "$IMAGE_LIST"
          index=0
          for url in "${ADDR[@]}"; do
            if [ ! -z "$url" ]; then
              curl -L -o "workspace/img_$index.png" "$url"
              echo "file 'workspace/img_$index.png'" >> images.txt
              echo "duration 3" >> images.txt
              ((index++))
            fi
          done
          # FFmpeg needs the last image repeated without duration
          echo "file 'workspace/img_$((index-1)).png'" >> images.txt
          
          curl -L -o "workspace/audio.mp3" "$AUDIO_URL"

          # Render using the manifest file (Much more stable)
          ffmpeg -f concat -safe 0 -i images.txt -i workspace/audio.mp3 \
          -c:v libx264 -pix_fmt yuv420p -t 18 -vf "scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920" \
          -y final_output.mp4

      - name: Upload_and_Callback
        run: |
          VIDEO_URL=$(curl --upload-file ./final_output.mp4 https://bashupload.com/final_video.mp4)
          curl -L -X POST "${{ github.event.client_payload.callback_url }}" \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"success\", \"download_url\": \"$VIDEO_URL\"}"
