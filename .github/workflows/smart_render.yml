name: Flux_Probe_DeepScan
on:
  repository_dispatch:
    types: [start_smart_render]

jobs:
  deep_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install_Minimal_Tools
        run: |
          pip install requests

      - name: Run_Diagnostic_Probe
        run: |
          python - <<EOF
          import requests, os, time

          def test_download(description, url_suffix):
              print(f"\n--- TESTING: {description} ---")
              # Using a very simple, direct URL structure
              base_url = "https://pollinations.ai/p/"
              final_url = base_url + url_suffix
              print(f"Target URL: {final_url}")

              # Stronger Browser Headers
              headers = {
                  'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                  'Accept': 'image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8',
                  'Referer': 'https://pollinations.ai/'
              }

              try:
                  response = requests.get(final_url, headers=headers, timeout=30, allow_redirects=True)
                  print(f"Status Code: {response.status_code}")
                  
                  # Inspect the content
                  content_size = len(response.content)
                  print(f"Downloaded Size: {content_size} bytes")

                  filename = f"debug_{int(time.time())}.jpg"
                  
                  if response.status_code == 200 and content_size > 5000:
                      print("✅ SUCCESS: Looks like a valid image.")
                      with open(filename, "wb") as f: f.write(response.content)
                  else:
                      print("❌ FAILURE: File is too small or error occurred.")
                      # CRITICAL: Print the content to see the error message
                      print("--- SERVER RESPONSE CONTENT ---")
                      try:
                          print(response.content.decode('utf-8')[:500])
                      except:
                          print("Cannot decode content (binary data).")
                      print("-------------------------------")
                      
              except Exception as e:
                  print(f"CRITICAL ERROR: {e}")

          # TEST 1: Simple Prompt, No Parameters (Default Model)
          test_download("Simple Prompt", "cat")

          # TEST 2: Flux Model Explicit
          test_download("Flux Model", "luxury_car?model=flux&width=1080&height=1920")

          # TEST 3: Seeded Flux (What we use in v28)
          test_download("Seeded Flux", "cyberpunk_city?model=flux&width=1080&height=1920&seed=42")
          EOF
