name: Viral_Video_Engine_v11
on:
  repository_dispatch:
    types: [start_smart_render]

jobs:
  build_video:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          # Unlock ImageMagick for TextClip
          sudo find /etc/ImageMagick* -name "policy.xml" -exec sed -i 's/policy domain="path" rights="none" pattern="@\*"/policy domain="path" rights="read|write" pattern="@\*"/g' {} +

      - name: Install Python Libraries
        run: |
          pip install moviepy==1.0.3 requests

      - name: Execution
        run: |
          python - <<EOF
          import os, requests, re, time
          from moviepy.editor import TextClip, AudioFileClip, concatenate_videoclips

          def download_file_from_google_drive(id, destination):
              URL = "https://docs.google.com/uc?export=download"
              session = requests.Session()
              session.headers.update({'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'})
              response = session.get(URL, params={'id': id}, stream=True)
              token = None
              for key, value in response.cookies.items():
                  if key.startswith('download_warning'):
                      token = value
                      break
              if token:
                  response = session.get(URL, params={'id': id, 'confirm': token}, stream=True)
              with open(destination, "wb") as f:
                  for chunk in response.iter_content(32768):
                      if chunk: f.write(chunk)

          try:
              # 1. Extraction
              raw_data = "${{ github.event.client_payload.visual_prompts }}"
              visual_prompts = [p.strip() for p in raw_data.split('|') if len(p.strip()) > 5]
              audio_url = "${{ github.event.client_payload.audio_url }}"
              audio_id = re.search(r'id=([a-zA-Z0-9_-]+)', audio_url).group(1)
              callback = "${{ github.event.client_payload.callback_url }}"
              
              # 2. Resilient Download
              print(f"Downloading Audio ID: {audio_id}")
              download_file_from_google_drive(audio_id, "audio_final.mp3")
              
              audio = AudioFileClip("audio_final.mp3")
              print(f"Audio Duration: {audio.duration} seconds")
              
              # 3. Rendering 10 Scenes
              dur = audio.duration / len(visual_prompts)
              clips = []
              for p in visual_prompts:
                  # Luxury minimalist text style
                  txt = TextClip(p, fontsize=45, color='white', font='Arial-Bold', size=(1080,1920), method='caption', align='center')
                  txt = txt.set_duration(dur).set_fps(24).resize(lambda t: 1 + 0.04 * t)
                  clips.append(txt)
              
              # 4. Final Assembly
              print("Stitching scenes and mixing high-end audio...")
              final = concatenate_videoclips(clips, method="compose").set_audio(audio)
              final.write_videofile("final_production.mp4", codec="libx264", audio_codec="aac", fps=24, threads=4)
              
              # 5. Uploading & Final Callback
              link = os.popen("curl --upload-file ./final_production.mp4 https://bashupload.com/video_viral_v11.mp4").read().strip()
              print(f"\n\nSUCCESS! DOWNLOAD LINK: {link}\n\n")
              
              requests.post(callback, json={"status": "success", "download_url": link}, timeout=20)

          except Exception as e:
              print(f"Production Halted: {str(e)}")
