name: Viral_Video_Action_v42
on:
  repository_dispatch:
    types: [start_smart_render]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install_Tools
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg imagemagick
          sudo find /etc/ImageMagick* -name "policy.xml" -exec sed -i 's/policy domain="path" rights="none" pattern="@\*"/policy domain="path" rights="read|write" pattern="@\*"/g' {} +
          # Fix for Screenshot 014259: installing pyav backend
          pip install "Pillow<10.0.0" moviepy==1.0.3 requests opencv-python-headless imageio-ffmpeg imageio[pyav]

      - name: Video_Rendering
        env:
          RAW_PAYLOAD: ${{ github.event.client_payload.visual_prompts }}
          AUDIO_URL: ${{ github.event.client_payload.audio_url }}
        run: |
          python - <<EOF
          import os, requests, re, urllib.parse, sys
          from moviepy.editor import TextClip, AudioFileClip, ImageClip, concatenate_videoclips, CompositeVideoClip

          def download_media(url, dest):
              try:
                  r = requests.get(url, stream=True, timeout=60)
                  if r.status_code == 200:
                      with open(dest, "wb") as f:
                          for c in r.iter_content(65536): f.write(c)
                      return True
              except: pass
              return False

          def get_visual(prompt, idx):
              # Ensuring the AI generates the high-end visuals you requested
              refined = "8k cinematic, ultra-luxury action, " + prompt.strip()
              encoded = urllib.parse.quote(refined)
              url = "https://pollinations.ai/p/" + encoded + "?width=1080&height=1920&seed=" + str(idx+777) + "&model=flux"
              if download_media(url, "f_" + str(idx) + ".jpg"):
                  return "f_" + str(idx) + ".jpg"
              return None

          try:
              raw_text = os.environ.get('RAW_PAYLOAD', '')
              # Extract visual_prompts if Gemini sent full JSON string
              if '"visual_prompts":' in raw_text:
                  prompts_str = raw_text.split('"visual_prompts":')[1].split('"')[1]
              else:
                  prompts_str = raw_text

              prompts = [p.strip() for p in prompts_str.split('|') if len(p.strip()) > 5]
              
              if not prompts:
                  prompts = ["Generate cinematic luxury video"]

              audio_url = os.environ.get('AUDIO_URL', '')
              audio_id = re.search(r'id=([a-zA-Z0-9_-]+)', audio_url).group(1)
              
              print("Downloading Master Audio...")
              download_media("https://docs.google.com/uc?export=download&id=" + audio_id, "audio.mp3")
              audio = AudioFileClip("audio.mp3")
              dur = audio.duration / len(prompts)
              
              clips = []
              for i, p in enumerate(prompts):
                  print("Generating Cinematic Scene " + str(i+1))
                  img_path = get_visual(p, i)
                  if img_path and os.path.exists(img_path):
                      img_clip = ImageClip(img_path).set_duration(dur).set_fps(24)
                      # Action Zoom Effect (Ken Burns)
                      img_clip = img_clip.resize(lambda t: 1 + 0.12 * t).set_position('center')
                      
                      txt = TextClip(p, fontsize=40, color='white', font='Arial-Bold', size=(900, 1600), method='caption').set_duration(dur)
                      scene = CompositeVideoClip([img_clip, txt.set_position(('center', 1400))])
                      clips.append(scene)
              
              if clips:
                  final = concatenate_videoclips(clips, method="compose").set_audio(audio)
                  # Screenshot 015921 fix: using ultra-safe preset
                  final.write_videofile("production_video.mp4", codec="libx264", audio_codec="aac", fps=24, preset="ultrafast")
                  print("RENDER_SUCCESS")
          except Exception as e:
              print("Process_Report: " + str(e))
          EOF

      - name: Save_Video_File
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: My_Final_Video
          path: production_video.mp4
          retention-days: 1

      - name: Agent_Callback
        if: always()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
          -H "Content-Type: application/json" \
          -d "{\"status\": \"finished\", \"info\": \"v42 Apex Complete\"}" || true
